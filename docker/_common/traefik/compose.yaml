services:
  traefik:
    container_name: traefik
    image: traefik:v3
    restart: unless-stopped
    command:
      - --configfile=/config/config.yaml
      - --providers.file.watch=true
    labels:
      tsdproxy.enable: true
      tsdproxy.ephemeral: true
      tsdproxy.name: internal-${CLUSTER_KEY}

      # Enable Traefik for itself
      traefik.enable: true
      # Dashboard configuration
      traefik.http.routers.dashboard.rule: Host(`internal.${CLUSTER_DOMAIN}`)
      traefik.http.routers.dashboard.entrypoints: websecure
      traefik.http.routers.dashboard.service: api@internal
      traefik.http.routers.dashboard.tls.certresolver: le
      # Dockge
      traefik.http.routers.dockge.rule: Host(`dockge.${CLUSTER_DOMAIN}`)
      traefik.http.routers.dockge.entrypoints: websecure
      traefik.http.routers.dockge.tls.certresolver: le
      traefik.http.routers.dockge.service: dockge
      traefik.http.services.dockge.loadbalancer.server.url: http://${CLUSTER_DOMAIN}:5001
    env_file:
      - path: .env
    ports:
      - 80:80
      - 443:443
      - 53:53/udp
      - 53:53/tcp
      - 853:853
      - 784:784/udp
      - 5443:5443
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./letsencrypt:/letsencrypt
      - ./config.yaml:/config/config.yaml
    networks:
      - dockge_default
x-dockge:
  urls:
    - https://internal.${CLUSTER_DOMAIN}
    - https://internal-${CLUSTER_KEY}.${tailscaleDomain}
networks:
  dockge_default:
    external: true
