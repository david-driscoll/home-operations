services:
  authentik_proxy:
    container_name: authentik-outpost
    image: ghcr.io/goauthentik/proxy:2025.8.4
    restart: unless-stopped
    # env is set in each app stack for the secret.
    env_file:
      - path: .env
        required: true
      - path: .env-token
        required: false
    labels:
      tsdproxy.enable: true
      tsdproxy.name: ${APP}-${CLUSTER_KEY}
      # Enable Traefik
      traefik.enable: true

      # Outpost
      traefik.http.routers.authentik-outpost.rule: Host(`${APP}.${CLUSTER_DOMAIN}`)
      traefik.http.routers.authentik-outpost.entrypoints: websecure
      traefik.http.routers.authentik-outpost.service: authentik-outpost
      traefik.http.routers.authentik-outpost.tls.certresolver: le
      traefik.http.services.authentik-outpost.loadbalancer.healthcheck.path: "/outpost.goauthentik.io/ping"
      traefik.http.services.authentik-outpost.loadbalancer.healthcheck.port: 9300
      traefik.http.services.authentik-outpost.loadbalancer.server.port: 9000

      # The middleware
      traefik.http.middlewares.authentik-outpost.forwardauth.address: http://authentik_proxy:9000/outpost.goauthentik.io/auth/traefik
      traefik.http.middlewares.authentik-outpost.forwardauth.trustForwardHeader: true
      traefik.http.middlewares.authentik-outpost.forwardauth.authResponseHeaders: X-authentik-username,X-authentik-groups,X-authentik-entitlements,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version
    networks:
      - dockge_default
    ports:
      - 9000:9000
x-dockge:
  urls:
    - https://${APP}.${CLUSTER_DOMAIN}
networks:
  dockge_default:
    external: true
