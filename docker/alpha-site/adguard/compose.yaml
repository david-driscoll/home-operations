services:
  adguard:
    cpus: 2
    restart: unless-stopped
    dns:
      - 100.100.100.100
    image: adguard/adguardhome:v0.107.70@sha256:33e2240c466b2bb1d4fe9d65fd86178160bf6ee8835cf7b50ab3a7c5e39571fe
    ports:
      - "4000:3000" # Keep direct access for local network
      - 53:53/udp
      - 53:53/tcp
      - 853:853
      - 784:784/udp
    environment:
      TZ: ${TIMEZONE}
    labels:
      # Enable Traefik
      traefik.enable: true

      # Web UI routing (HTTPS)
      traefik.http.routers.adguard.rule: Host(`${APP}.${searchDomain}`)
      traefik.http.routers.adguard.entrypoints: websecure
      traefik.http.routers.adguard.tls.certresolver: le
      traefik.http.routers.adguard.service: adguard-web

      traefik.http.routers.adguard-tailscale.rule: Host(`adguard-${host}.${tailscaleDomain}`)
      traefik.http.routers.adguard-tailscale.entrypoints: tailscale
      traefik.http.routers.adguard-tailscale.service: adguard-web

      traefik.http.services.adguard-web.loadbalancer.server.port: 3000

      # DNS over HTTPS (DoH) - port 443 via HTTPS
      traefik.http.routers.adguard-doh.rule: Host(`adguard.${searchDomain}`) && Path(`/dns-query`)
      traefik.http.routers.adguard-doh.entrypoints: websecure
      traefik.http.routers.adguard-doh.tls.certresolver: le
      traefik.http.routers.adguard-doh.service: adguard-doh
      traefik.http.services.adguard-doh.loadbalancer.server.port: 443
    volumes:
      - ./workdir:/opt/adguardhome/work
      - ./confdir:/opt/adguardhome/conf
      - ./letsencrypt:/etc/letsencrypt
    networks:
      - dockge_default
networks:
  dockge_default:
    external: true
x-dockge:
  urls:
    - https://${APP}.${searchDomain}
    - https://adguard.${tailscaleDomain}
